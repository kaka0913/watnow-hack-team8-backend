## Goアプリケーション実装ルール (ドメイン駆動設計 + クリーンアーキテクチャ)

このルールは、アプリケーションの保守性とテスト容易性を高めるためのドメイン駆動設計とクリーンアーキテクチャを維持することを目的とします。
以下のルールに従ってコードを生成・レビューしてください。

---

### 0. 使用パッケージ・技術スタック

#### **メインパッケージ**
| パッケージ | バージョン | 用途 |
|-----------|-----------|------|
| `gin-gonic/gin` | v1.10.1 | **HTTPフレームワーク** - REST APIの実装 |
| `supabase-community/supabase-go` | v0.0.4 | **Supabaseクライアント** - データベース接続・操作 |
| `joho/godotenv` | v1.5.1 | **環境変数管理** - .envファイルの読み込み |
| `google/uuid` | v1.6.0 | **UUID生成** - 一意識別子の生成 |
| `paulmach/orb` | v0.11.1 | **地理情報処理** - 座標・地理データの操作 |

#### **データベース・インフラ**
| 技術 | 用途 |
|------|------|
| **Supabase (PostgreSQL + PostGIS)** | メインデータベース・地理情報処理 |
| **PostGIS** | 地理空間データの格納・検索 |
| **Cloud Run** | サーバーレスAPIホスティング |
| **Google Cloud Platform** | インフラストラクチャ |
| **Google Maps API** | 経路検索・地理情報サービス |

---

### 1. ディレクトリ構造の規約

各コンポーネントは、その役割に応じて指定されたディレクトリに配置されなければなりません。

| ディレクトリ                           | 役割                                                         |
| -------------------------------------- | ------------------------------------------------------------ |
| `cmd/`                                 | アプリケーションのエントリーポイント（`main`パッケージ）を配置します。依存性の注入とサーバー起動のみを行います。 |
| `internal/handler/`                    | **プレゼンテーション層**。HTTPリクエストの解釈とレスポンスの生成を担当します。 |
| `internal/usecase/`                    | **アプリケーション層**。アプリケーション固有のユースケースを実装します。 |
| `internal/domain/model/`               | **ドメインモデル**。ビジネスの核となるエンティティと値オブジェクトを定義します。 |
| `internal/domain/service/`             | **ドメインサービス**。複数のエンティティにまたがるビジネスロジックを実装します。 |
| `internal/domain/repository/`          | **ドメインリポジトリインターフェース**。データアクセスの抽象化を定義します。 |
| `internal/domain/strategy/`            | **ストラテジーパターン**。テーマ別のルート生成戦略を実装します。 |
| `internal/domain/helper/`              | **ドメインヘルパー**。ドメイン内で使用される汎用的な関数を実装します。 |
| `internal/repository/`                 | **インフラストラクチャ層（リポジトリ実装）**。具体的なデータアクセス処理を実装します。 |
| `internal/infrastructure/database/`    | **データベース接続層**。Supabaseクライアントの初期化・設定を管理します。 |
| `internal/infrastructure/maps/`        | **外部API層**。Google Maps APIなどの外部サービス連携を実装します。 |

---

### 2. アーキテクチャ概要

このアプリケーションは **ドメイン駆動設計（DDD）** と **クリーンアーキテクチャ** の原則に基づいて構築されています。

#### **依存関係の方向**
```
Handler -> UseCase -> Domain Service -> Domain Repository Interface
                   ↗        ↓
Infrastructure ←----------- Domain Model
```

#### **各層の独立性**
- **ドメイン層**: 他の層に依存しない純粋なビジネスロジック
- **アプリケーション層**: ドメイン層のみに依存
- **インフラストラクチャ層**: ドメイン層のインターフェースを実装
- **プレゼンテーション層**: アプリケーション層とドメイン層に依存

---

### 3. 依存関係のルール

#### **許可されるインポート**:
* `handler` は `usecase` と `domain/model` をインポートできます。
* `usecase` は `domain` 以下の全てをインポートできます。
* `domain/service` は `domain/model`, `domain/repository`, `domain/strategy`, `domain/helper` をインポートできます。
* `domain/strategy` は `domain/model`, `domain/repository`, `domain/helper` をインポートできます。
* `domain/helper` は `domain/model` のみをインポートできます。
* `repository` (実装) は `domain/model` と `domain/repository` (インターフェース) をインポートできます。
* `infrastructure` は `domain` 以下をインポートできます。

#### **禁止されるインポート**:
* `domain` 以下は `handler`, `usecase`, `repository` (実装), `infrastructure` をインポートしては**いけません**。
* `usecase` は `handler`, `repository` (実装), `infrastructure` をインポートしては**いけません**。
* 上位層から下位層への依存は禁止されています。

---

### 4. 各レイヤーの実装責務

#### **Handler層 (`internal/handler/`)**
* **役割**: HTTPリクエストとレスポンスの処理
* **ルール**:
    * HTTPリクエストからパラメータを読み取り、適切な型に変換
    * `usecase` 層のメソッドを呼び出し
    * 結果をJSONなどの適切な形式でレスポンス
    * ビジネスロジックを含めては**いけません**
    * データベースや外部APIに直接アクセスしては**いけません**

#### **UseCase層 (`internal/usecase/`)**
* **役割**: アプリケーション固有のユースケースの実装
* **ルール**:
    * 特定のアプリケーション要件に基づく処理フローを実装
    * ドメインサービスやリポジトリを組み合わせてユースケースを実現
    * HTTPに依存するコードを含めては**いけません**
    * データベースアクセスは必ずリポジトリ経由で行う

#### **Domain Service層 (`internal/domain/service/`)**
* **役割**: 複数のエンティティにまたがるビジネスロジック
* **ルール**:
    * 純粋なビジネスルールを実装
    * 外部システム（DB、API）への依存はインターフェース経由のみ
    * ドメイン知識の中核を担う
    * フレームワークやインフラに依存しない

#### **Domain Strategy層 (`internal/domain/strategy/`)**
* **役割**: アルゴリズムの実装（Strategy Pattern）
* **ルール**:
    * テーマ別のルート生成アルゴリズムを実装
    * 戦略の切り替えが容易になるよう設計
    * ビジネスルールの変更に柔軟に対応

#### **Repository Interface層 (`internal/domain/repository/`)**
* **役割**: データアクセスの抽象化
* **ルール**:
    * データの永続化方法を抽象化
    * 具体的な実装は `internal/repository/` で行う
    * ドメイン層の純粋性を保つ

#### **Repository Implementation層 (`internal/repository/`)**
* **役割**: 具体的なデータアクセス処理
* **ルール**:
    * データベースや外部APIとの通信を実装
    * ドメインリポジトリインターフェースを実装
    * ビジネスロジックを含めては**いけません**

#### **Infrastructure層 (`internal/infrastructure/`)**
* **役割**: 外部システムとの連携
* **ルール**:
    * データベース接続、外部API呼び出しなどの技術的詳細を実装
    * ドメイン層のインターフェースを実装
    * ビジネスロジックを含めては**いけません**

---


レイヤー間の結合度を下げるため、インターフェースを介して依存関係を解決します。

* `usecase` は `domain/repository` の**インターフェース**に依存しなければなりません。
* `domain/service` は `domain/repository` の**インターフェース**に依存しなければなりません。
* `handler` は `usecase` の**インターフェース**に依存しなければなりません。
* 各コンポーネントの具象インスタンスの生成と、それらの依存関係の組み立て（注入）は、アプリケーションのエントリーポイント（例: `cmd/main.go`）で行います。

---

### 6. ドメイン駆動設計の適用

#### **エンティティ (Entity)**
* `POI`, `Walk`, `GridCell` などの一意性を持つオブジェクト
* ライフサイクルを通じて追跡される
* ビジネス上重要な概念を表現

#### **値オブジェクト (Value Object)**
* `LatLng`, `Location`, `Geometry` などの不変オブジェクト
* 等価性は属性の値で判定される
* 交換可能で副作用がない

#### **ドメインサービス (Domain Service)**
* 複数のエンティティにまたがる操作
* エンティティや値オブジェクトに属さないビジネスロジック
* 例: `RouteSuggestionService`

#### **リポジトリ (Repository)**
* エンティティの永続化を抽象化
* ドメイン層ではインターフェースのみ定義
* 実装はインフラストラクチャ層で行う

#### **ストラテジー (Strategy)**
* アルゴリズムのファミリーを定義し、交換可能にする
* 例: テーマ別のルート生成戦略

---

### 7. 実装時の注意事項

#### **テスト容易性**
* 各層は独立してテスト可能でなければなりません
* インターフェースを使用することで、モックやスタブが容易に作成できます
* ドメイン層のテストは外部依存なしで実行できなければなりません

#### **エラーハンドリング**
* ビジネスエラーとシステムエラーを明確に区別します
* ドメインエラーはドメイン層で定義します
* システムエラーは適切なレイヤーで変換・ハンドリングします

#### **パフォーマンス**
* データベースアクセスは適切にバッチ化します
* 並行処理を活用する際は、適切な同期機構を使用します
* キャッシュは必要に応じてインフラストラクチャ層で実装します

---

### 8. ドキュメントリファレンス

詳細なAPI仕様については以下のドキュメントを参照してください：

* **[ドメイン層 API リファレンス](./domain-api-reference.md)** - インターフェイスとデータ型の詳細
* **[ドメインアーキテクチャ詳細](./domain-architecture.md)** - ドメイン層の実装詳細
* **[ルート提案仕様](./route-proposal.md)** - ルート生成ロジックの詳細

これらのドキュメントを参照することで、実装詳細を知らずにドメイン層を利用できます。