## Goアプリケーション実装ルール (3層アーキテクチャ)

このルールは、アプリケーションの保守性とテスト容易性を高めるための3層アーキテクチャを維持することを目的とします。
以下のルールに従ってコードを生成・レビューしてください。

---

### 0. 使用パッケージ・技術スタック

#### **メインパッケージ**
| パッケージ | バージョン | 用途 |
|-----------|-----------|------|
| `gin-gonic/gin` | v1.10.1 | **HTTPフレームワーク** - REST APIの実装 |
| `supabase-community/supabase-go` | v0.0.4 | **Supabaseクライアント** - データベース接続・操作 |
| `joho/godotenv` | v1.5.1 | **環境変数管理** - .envファイルの読み込み |
| `google/uuid` | v1.6.0 | **UUID生成** - 一意識別子の生成 |
| `paulmach/orb` | v0.11.1 | **地理情報処理** - 座標・地理データの操作 |

#### **データベース・インフラ**
| 技術 | 用途 |
|------|------|
| **Supabase (PostgreSQL + PostGIS)** | メインデータベース・地理情報処理 |
| **PostGIS** | 地理空間データの格納・検索 |
| **Cloud Run** | サーバーレスAPIホスティング |
| **Google Cloud Platform** | インフラストラクチャ |

---

### 1. ディレクトリ構造の規約

各コンポーネントは、その役割に応じて指定されたディレクトリに配置されなければなりません。

| ディレクトリ                 | 役割                                                         |
| ---------------------------- | ------------------------------------------------------------ |
| `cmd/`                       | アプリケーションのエントリーポイント（`main`パッケージ）を配置します。依存性の注入とサーバー起動のみを行います。 |
| `internal/handler/`          | **プレゼンテーション層**。HTTPリクエストの解釈とレスポンスの生成を担当します。 |
| `internal/service/`          | **ビジネスロジック層**。アプリケーション固有のビジネスルールを実装します。 |
| `internal/repository/`       | **データアクセス層**。データベースや外部APIとの通信を抽象化します。 |
| `internal/database/`         | **データベース接続層**。Supabaseクライアントの初期化・設定を管理します。 |
| `model/`                     | アプリケーション全体で利用するデータ構造（構造体）を定義します。 |

---

### 2. 依存関係のルール

レイヤー間の依存関係は、以下の図の**一方向**でなければなりません。

**`handler` -> `service` -> `repository`**

* **許可されるインポート**:
    * `handler` は `service` をインポートできます。
    * `service` は `repository` をインポートできます。
    * `handler`, `service`, `repository` は `model` をインポートできます。

* **禁止されるインポート**:
    * `repository` は `service` や `handler` をインポートしては**いけません**。
    * `service` は `handler` をインポートしては**いけません**。
    * `model` は `handler`, `service`, `repository` をインポートしては**いけません**。

---

### 3. 各レイヤーの実装責務

各レイヤーは、指定された責務のみを実装しなければなりません。

#### **Handler層 (`internal/handler/`)**
* **役割**: HTTPリクエストとレスポンスの処理
* **ルール**:
    * `net/http` の `http.Request` からパラメータ（パス、クエリ、ボディ）を読み取ります。
    * 読み取った値を `service` 層のメソッドに渡します。
    * `service` 層から返された結果をJSONなどの形式に変換し、`http.ResponseWriter` に書き込みます。
    * ビジネスロジック（例: データの内容に基づいた条件分岐）を実装しては**いけません**。

#### **Service層 (`internal/service/`)**
* **役割**: ビジネスロジックの実行
* **ルール**:
    * アプリケーションの核心的なルールや処理フローを実装します。
    * データ操作が必要な場合は、`repository` 層のメソッドを呼び出します。
    * HTTPに依存するコード (`net/http`パッケージなど) を含めては**いけません**。

#### **Repository層 (`internal/repository/`)**
* **役割**: データ永続化処理の抽象化
* **ルール**:
    * データベースへのCRUD（作成、読み取り、更新、削除）操作や、外部APIの呼び出しを実装します。
    * SQL文やAPIクライアントの実装はこの層に隠蔽します。
    * ビジネスロジックを含めては**いけません**。

---

### 4. 抽象化と依存性の注入 (DI)

レイヤー間の結合度を下げるため、インターフェースを介して依存関係を解決します。

* `service` は `repository` の**インターフェース**に依存しなければなりません。
* `handler` は `service` の**インターフェース**に依存しなければなりません。
* 各コンポーネントの具象インスタンスの生成と、それらの依存関係の組み立て（注入）は、アプリケーションのエントリーポイント（例: `cmd/main.go`）で行います。